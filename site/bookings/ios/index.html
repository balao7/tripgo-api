<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="SkedGo Pty Ltd">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>iOS SDK - TripGo Developer</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">TripGo Developer</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../advanced/">Advanced</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Bookings <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../overview/">Overview</a>
</li>

                        
                            
<li >
    <a href="../android/">Android SDK</a>
</li>

                        
                            
<li class="active">
    <a href="./">iOS SDK</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../android/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="disabled">
                        <a rel="prev" >
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/skedgo/tripgo-api">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#bookings-in-tripkit-ios">Bookings in TripKit iOS</a></li>
        
            <li><a href="#preparations">Preparations</a></li>
        
            <li><a href="#linking-and-unlinking-accounts">Linking and unlinking accounts</a></li>
        
            <li><a href="#getting-available-tsp-products-for-a-trip">Getting available TSP products for a trip</a></li>
        
            <li><a href="#booking-a-segment">Booking a segment</a></li>
        
            <li><a href="#updating-trip-with-booking-details">Updating trip with booking details</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="bookings-in-tripkit-ios">Bookings in TripKit iOS</h1>
<p><strong>Note: Enterprise customers-only</strong></p>
<p><strong>Note: Beta-only</strong></p>
<p>TripKit iOS supports all the booking API endpoints, including handling the OAuth process. OAuth credentials are stored securely in the device's keychain and, optionally, linked to the user's account.</p>
<h2 id="preparations">Preparations</h2>
<p>To get started, configured your project as follows:</p>
<ol>
<li>Include <code>BookingKit</code> from <code>shared-ios</code>, including all its dependencies.</li>
<li>Include <code>tripkit-ios</code> as a dependency, including its <code>Bookings</code> add-on.</li>
<li>Add the <code>OAuthCallbackURL</code> to your <code>Config.plist</code> configuration file.</li>
<li>Make sure your app has the URL scheme from that callback URL registered.</li>
</ol>
<p>Next, you need to respond to calls to that <code>OAuthCallbackURL</code> in your application delegate by implementing <code>application(openURL:options)</code> (or its deprecated precursors), and handling the calls similar to this:</p>
<pre><code class="swift">let OAuthCallbackURL = SGKConfig.sharedIntance().oauthCallbackURL()
if (URL.absoluteString.hasPrefix(OAuthCallbackURL.absoluteString)) {
  OAuthSwift.handleOpenURL(URL)
  return true
}
</code></pre>

<hr />
<h2 id="linking-and-unlinking-accounts">Linking and unlinking accounts</h2>
<p>You can then which accounts are available for linking for a given region:</p>
<pre><code class="swift">let region = SVKRegionManager.sharedInstance().regionWithName(...)
region.linkedAccounts() { auths in
  for auth in auths {
    if auth.isConnected {
      // Update UI and allow unlinking
    } else {
      // Update UI and allow linking
    }
  }
}
</code></pre>

<p>This both checks which modes can be associated with an account, and also whether the credentials are already available. Credentials are available when they are either stored locally or associated with the user's account, <strong>and</strong> they have not expired.</p>
<p>To kick of linking, which saves the credentials locally and to the user's account (if the user is logged in), there's a helper based on <code>RxSwift</code>:</p>
<pre><code class="swift">region.rx_linkAccount(mode, remoteURL: auth.actionURL)
  .subscribe { event in
    switch event {
    case .Next(let success):
      // Account has been linked. Update the UI.
    case .Error(let error):
      // Account could not get linked. Handle error.
      print(error)
    case .Completed:
      break // Nothing to do
    }
  }
  .addDisposableTo(disposeBag)
</code></pre>

<p>Note that this helper requires the <code>actionURL</code> as this is used to fetch what information is necessary for the OAuth flow for the provider servicing the specified <code>mode</code>:</p>
<p>These credentials will then be used automatically later on when bookings are made. To check, whether credentials are currently stored and still valid (they can expire), you can use the <code>region.linkedAccounts()</code> helper above.</p>
<p>For unlinking an account again there's another helper:</p>
<pre><code class="swift">region.unlinkAccount(mode, remoteURL: auth.actionURL) { success in
  // Do something
}
</code></pre>

<p>Note that the helper for unlinking, only requires the <code>actionURL</code> when the OAuth credentials have been associated with the user's account. Unlinking removes credentials stored locally and those associated with the user's account.</p>
<hr />
<h2 id="getting-available-tsp-products-for-a-trip">Getting available TSP products for a trip</h2>
<p><code>// TODO</code></p>
<pre><code class="swift">TKQuickBookingHelper.fetchQuickBookings(forSegment: segment) { quickBookings in
  // Update UI
}
</code></pre>

<hr />
<h2 id="booking-a-segment">Booking a segment</h2>
<p><code>// TODO</code></p>
<pre><code class="swift">let mode = segment.modeIdentifier()
BPKOperator.makeBookingToURL(mode, URL: bookingURL)
  .subscribe { event in
    switch event {
    case .Next(let result):
      switch result {
      case .UpdateTrip(let url):
        // Booking went through. Update the trip (see below).
      case .LoadForm(let form):
        // More information required.
        // Display booking form using `BPKBookingViewController`
      }
    case .Error(let error):
      // Handle error
    case .Completed:
      break // Nothing to do
    }
  }
  .addDisposableTo(disposeBag)
}

</code></pre>

<hr />
<h2 id="updating-trip-with-booking-details">Updating trip with booking details</h2>
<p><code>// TODO</code></p>
<pre><code class="swift">let router = TKBuzzRouter()
let context = TKTripKit.sharedInstance().tripKitContext
router.downloadTrip(url, intoTripKitContext: context) { updatedTrip in
  if let updatedTrip = updatedTrip {
    let request = originalTrip.request
    originalTrip.removeFromRequest()
    updatedTrip.moveToRequest(request, markAsPreferred: true)
  }
}
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
