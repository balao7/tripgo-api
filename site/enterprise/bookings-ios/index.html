<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="SkedGo Pty Ltd">
		
		<link rel="apple-touch-icon" sizes="57x57" href="../../img/favicon/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="../../img/favicon/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="../../img/favicon/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="../../img/favicon/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="../../img/favicon/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="../../img/favicon/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="../../img/favicon/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="../../img/favicon/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="../../img/favicon/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="../../img/favicon/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="../../img/favicon/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="../../img/favicon/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="../../img/favicon/favicon-16x16.png">
		<link rel="manifest" href="../../img/favicon/manifest.json">
		<meta name="msapplication-TileColor" content="#154c7b">
		<meta name="msapplication-TileImage" content="../../img/favicon/ms-icon-144x144.png">
		<meta name="theme-color" content="#154c7b">
		<title>Bookings (iOS) - TripGo Developer</title>
		<link rel="stylesheet" href="../../css/main.css">
		<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
		<![endif]-->
	        <script>
	            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	            ga('create', 'UA-33335816-3', 'developer.tripgo.com');
	            ga('send', 'pageview');
	        </script> 
	</head>
	<body >
		<header class="navbar">
	<div class="search-container">
		<a class="search" href="#"></a>
		<div class="search-form" id="mkdocs_search_modal" tabindex="-1" raria-labelledby="Search Modal" aria-hidden="true">
    <form role="form" class="container">
        <div class="search-icon"></div>
        <input type="text" class="search-field" placeholder="Type keyword..." id="mkdocs-search-query">
    </form>
    <div class="results-list">
    	<div id="mkdocs-search-results" class="container"></div>
    </div>
</div>
	</div>
	<div class="container-fluid">
		<a class="logo" href="../..">
			<img src="../../img/tripgo-api-logo-white.svg" alt="TripGo API Logo White" height="32" width="140">
		</a>

		<div class="divider"></div>
		<a class="menu-toggle" type="button" href="#" aria-hidden="true">
			<div class="bar-container">
				<span class="bar-1"></span>
				<span class="bar-2"></span>
				<span class="bar-3"></span>
			</div>
		</a>
		<div class="menu" aria-hidden="false">
			
				<ul>
					
						
							<li class="">
								<a href="../..">Getting Started</a>
							</li>
						
					
						
							<li class="">
								<a href="../../faq/">F.A.Q.</a>
							</li>
						
					
						
							<li class="">
								<a href="../../extensions/">Extensions</a>
							</li>
						
					
						
							<li>
								<a href="#" class="dropdown">Enterprise</a>
								<ul class="submenu">
									
										<li class="">
											<a href="../push/">Push Notifications</a>
										</li>
									
										<li class="">
											<a href="../bookings-api/">Bookings (API)</a>
										</li>
									
										<li class="current">
											<a href="./">Bookings (iOS)</a>
										</li>
									
								</ul>
							</li>
						
					
				</ul>
			
		</div>
		
	</div>
	
</header>
		
		<div class="container -layout-3-9">
                <div class="col" role="complementary"><div class="sidebar hidden-print affix" role="complementary" id="sidebar">
	<div class="indicator"></div>
    <ul class="nav sidenav">
        <li class="main "><a href="#bookings-in-tripkit-ios" class="active">Bookings in TripKit iOS</a></li>
            <li><a href="#preparations" class="">Preparations</a></li>
            <li><a href="#linking-and-unlinking-accounts" class="">Linking and unlinking accounts</a></li>
            <li><a href="#getting-available-tsp-products-for-a-trip" class="">Getting available TSP products for a trip</a></li>
            <li><a href="#booking-a-segment" class="">Booking a segment</a></li>
            <li><a href="#updating-trip-with-booking-details-confirmation" class="">Updating trip with booking details / confirmation</a></li>
    </ul>
</div></div>
                <div class="col content" role="main">

<h1 id="bookings-in-tripkit-ios">Bookings in TripKit iOS</h1>
<p><strong>Note: Enterprise customers-only</strong></p>
<p><strong>Note: Beta-only</strong></p>
<p>TripKit iOS supports all the booking API endpoints, including handling the OAuth process. OAuth credentials are stored securely in the device's keychain and, optionally, linked to the user's account.</p>
<h2 id="preparations">Preparations</h2>
<p>To get started, configured your project as follows:</p>
<ol>
<li>Include <code>BookingKit</code> from <code>shared-ios</code>, including all its dependencies.</li>
<li>Include <code>tripkit-ios</code> as a dependency, including its <code>Bookings</code> add-on.</li>
<li>Add the <code>OAuthCallbackURL</code> to your <code>Config.plist</code> configuration file.</li>
<li>Make sure your app has the URL scheme from that callback URL registered.</li>
</ol>
<p>Next, you need to respond to calls to that <code>OAuthCallbackURL</code> in your application delegate by implementing <code>application(openURL:options)</code> (or its deprecated precursors), and handling the calls similar to this:</p>
<pre><code class="swift">let OAuthCallbackURL = SGKConfig.sharedIntance().oauthCallbackURL()
if (URL.absoluteString.hasPrefix(OAuthCallbackURL.absoluteString)) {
  OAuthSwift.handleOpenURL(URL)
  return true
}
</code></pre>

<hr />
<h2 id="linking-and-unlinking-accounts">Linking and unlinking accounts</h2>
<p>You can then which accounts are available for linking for a given region:</p>
<pre><code class="swift">let region = SVKRegionManager.sharedInstance().regionWithName(...)
region.linkedAccounts() { auths in
  for auth in auths {
    if auth.isConnected {
      // Update UI and allow unlinking
    } else {
      // Update UI and allow linking
    }
  }
}
</code></pre>

<p>This both checks which modes can be associated with an account, and also whether the credentials are already available. Credentials are available when they are either stored locally or associated with the user's account, <strong>and</strong> they have not expired.</p>
<p>To kick of linking, which saves the credentials locally and to the user's account (if the user is logged in), there's a helper based on <code>RxSwift</code>:</p>
<pre><code class="swift">region.rx_linkAccount(mode, remoteURL: auth.actionURL)
  .subscribe { event in
    switch event {
    case .Next(let success):
      // Account has been linked. Update the UI.
    case .Error(let error):
      // Account could not get linked. Handle error.
      print(error)
    case .Completed:
      break // Nothing to do
    }
  }
  .addDisposableTo(disposeBag)
</code></pre>

<p>Note that this helper requires the <code>actionURL</code> as this is used to fetch what information is necessary for the OAuth flow for the provider servicing the specified <code>mode</code>:</p>
<p>These credentials will then be used automatically later on when bookings are made. To check, whether credentials are currently stored and still valid (they can expire), you can use the <code>region.linkedAccounts()</code> helper above.</p>
<p>For unlinking an account again there's another helper:</p>
<pre><code class="swift">region.unlinkAccount(mode, remoteURL: auth.actionURL) { success in
  // Do something
}
</code></pre>

<p>Note that the helper for unlinking, only requires the <code>actionURL</code> when the OAuth credentials have been associated with the user's account. Unlinking removes credentials stored locally and those associated with the user's account.</p>
<hr />
<h2 id="getting-available-tsp-products-for-a-trip">Getting available TSP products for a trip</h2>
<p>Available TSP products for a trip are associated with a segment. The information about these products is not included in the standard routing responses, but needs to be fetched separately.</p>
<p>Whether such TSP products are available, is indicated by the segment having a <code>bookingQuickInternalURL</code>. If that URL exists, the <code>TKQuickBookingHelper</code> can then fetch all the available products:</p>
<pre><code class="swift">TKQuickBookingHelper.fetchQuickBookings(forSegment: segment) { quickBookings in
  // Update UI
}
</code></pre>

<p><strong>Note</strong>: Fetching this information does typically not require the user to have linked their account with the TSP of that segment.</p>
<p>Each of these come with a variety of information about the product, possibly including information on the price or ETA.</p>
<p>The two main actions that you can take with these details are:</p>
<ol>
<li>Update the trip with the product, using the <code>tripUpdateURL</code> (see below for details). This is useful if you need the trip's properties to reflect the price and ETA of the selected product.</li>
<li>Book the product, the using <code>bookingURL</code> (see below for details).</li>
</ol>
<hr />
<h2 id="booking-a-segment">Booking a segment</h2>
<p>Users can book trip on a segment-by-segment basis. The booking requires the <code>bookingURL</code> for the specific product that the user wants to book as mentioned in the previous section.</p>
<p>TripKit iOS has a helper method <code>BPKOperator.makeBookingToURL/2</code> which then initiates the booking:</p>
<pre><code class="swift">let mode = segment.modeIdentifier()
BPKOperator.makeBookingToURL(mode, URL: bookingURL)
  .subscribe { event in
    switch event {
    case .Next(.UpdateTrip(let url)):
      // Booking went through. Update the trip (see below).
    case .Next(.LoadForm(let form)):
      // More information required.
      // Display booking form using `BPKBookingViewController`
    case .Next(.ShowAgreement(let displayUrl, let discardUrl))
      // User confirmation required.
    case .Error(let error):
      // Handle error
    case .Completed:
      break // Nothing to do
    }
  }
  .addDisposableTo(disposeBag)
}
</code></pre>

<p>This method does a handful of things:</p>
<ol>
<li>It checks whether the user has already linked their account for the provider of the segment (the credentials are linked to the segment's mode, which is why the method takes the <code>mode</code> parameter).<ul>
<li>If the user's account has not been linked, the <code>BPKOperator</code> will start the OAuth process described <a href="#linking-and-unlinking-accounts">in the section on linking accounts</a>.</li>
<li>If the user's account has already been linked, those credentials will be used.</li>
<li>If there's an error during this process, then observable aborts with an error.</li>
</ul>
</li>
<li>An attempt to make the booking is performed, which can have the following outcomes:<ul>
<li>The booking was successful and <code>BookingResult.UpdateTrip</code> is returned with a URL to update the trip, which will then include the confirmation details.</li>
<li>The booking can be made, but more information is required by the user. This is the case <code>BookingResult.LoadTrip</code> which returns a booking form, which can be then be displayed using the <code>BPKBookingViewController</code>.</li>
<li>The booking can be made, but the user first need to accept an agreement. This is the case <code>`BookingResult.UpdateTrip</code> which returns two URLs. The first URL should be displayed to the user, and the user has accepted the terms once the user gets to the second URL. If the user accepted, you should then kick off the initial call to <code>BPKOperator.makeBookingToURL</code> again.</li>
<li>If there's an error, the observable aborts with an error.</li>
</ul>
</li>
</ol>
<hr />
<h2 id="updating-trip-with-booking-details-confirmation">Updating trip with booking details / confirmation</h2>
<p>As described above, the booking process provides URLs to fetch an update of the trip. This can be used to update a trip with a selected TSP process, and also to fetch the booking status of a trip.</p>
<p>This process is the same as updating a trip with real-time data, e.g.:</p>
<pre><code class="swift">let router = TKBuzzRouter()
let context = TKTripKit.sharedInstance().tripKitContext
router.downloadTrip(url, intoTripKitContext: context) { updatedTrip in
  if let updatedTrip = updatedTrip {
    let request = originalTrip.request
    originalTrip.removeFromRequest()
    updatedTrip.moveToRequest(request, markAsPreferred: true)
  }
}
</code></pre>

<p>Noteworthy is here, the <code>segment.bookingConfirmation</code> property provided by <code>TKQuickBookingHelper</code> which returns a <code>TKBookingConfirmation</code> struct after a booking has been made. This struct includes:</p>
<ul>
<li><code>status</code>: A title and optional description describing the current status of the trip.</li>
<li>Information on the <code>provider</code> and <code>vehicle</code> servicing this booking. Note that these can be missing; typically while the booking is still being processed by the TSP, in the cast that it has been cancelled, or also after the trip has been completed.</li>
<li>A list of actions, such as calling the provider or cancelling the booking.</li>
</ul></div>
		</div>
		<div class="navbar-bottom" role="navigation">
	<div class="container -layout-6-6">
			    <div class="col">
			        <a rel="next" href="../bookings-api/" class="prev">
			            <div class="label">
			            	Previous
			            </div>
			            <div class="title">
			            	Bookings (API)
			            </div>
			        </a>
			    </div>
			    <div class="disabled col">
			        <a rel="prev"  class="next">
			            <div class="label">
			            	Next
			            </div>
			            <div class="title">
			            	
			            </div>
			        </a>
			    </div>
	</div>
</div>
		<footer class="footer">
	<div class="logo">
		<img src="../../img/tripgo-api-logo-mono.svg" alt="TripGo Logo" width="134" height="34">
	</div>
	<ul class="menu">
		<li>
			<a href="https://www.skedgo.com">SkedGo website</a>
		</li>
		<li>
			<a href="https://skedgo.com/en/tripgo-api/pricing/">Pricing</a>
		</li>
		<li>
			<a href="https://github.com/skedgo/tripgo-api/issues">Report issue</a>
		</li>
		<li>
			<a href="mailto:support@skedgo.com">Email support</a>
		</li>
		<li>
			<a href="http://slack.tripgo.com/">Slack community</a>
		</li>
	</ul>
</footer>
		<script>var base_url = '../..';</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
		<script src="../../js/app.min.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>